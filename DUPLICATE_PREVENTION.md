# 重复文件上传预防机制

## 问题描述

之前的版本存在以下问题：
1. 同一个文件可能会被重复上传，占用双倍存储空间
2. 没有有效的机制来检测文件是否已经存在于云端
3. 文件内容没有变化时仍然会上传

## 解决方案

### 1. 改进的文件比较逻辑

- **校验和检查**：使用SHA1校验和来检测文件内容是否真正改变
- **元数据比较**：比较文件大小、修改时间等元数据
- **智能跳过**：如果文件内容未改变，只更新本地状态，跳过上传

### 2. 云端文件检查

- **预检查**：上传前检查B2是否已存在相同文件
- **大小比较**：如果文件大小相同，可能内容也相同
- **元数据存储**：在B2中存储文件的校验和信息

### 3. 元数据策略

为了避免 `LOCAL_STATE_PATH` 和 `.meta` 文件的重复，提供了三种策略：

#### 策略对比

| 策略 | 检测方式 | 元数据文件 | 存储开销 | 检测精度 | 推荐场景 |
|------|----------|------------|----------|----------|----------|
| `none` | 无检测 | 无 | 最小 | 无 | 测试环境 |
| `basic` | 文件大小比较 | 无 | 小 | 中等 | 一般使用 |
| `full` | 校验和比较 | 有 | 中等 | 最高 | 重要数据 |

#### 详细说明

**`none` 策略**
- 不进行任何重复检测
- 每次都上传文件
- 适用于测试或调试

**`basic` 策略（推荐）**
- 使用文件大小进行快速检测
- 不创建额外的元数据文件
- 依赖本地状态文件进行详细跟踪
- 平衡了效率和存储开销

**`full` 策略**
- 使用校验和进行精确检测
- 为每个文件创建 `.meta` 元数据文件
- 提供最高的检测精度
- 适用于重要数据备份

### 4. 配置选项

```bash
# 是否启用重复检测
ENABLE_METADATA_CHECK=true

# 元数据策略
METADATA_STRATEGY=basic  # none, basic, full
```

## 使用方法

### 1. 基本策略（推荐）
```bash
ENABLE_METADATA_CHECK=true
METADATA_STRATEGY=basic
```

### 2. 完整策略（高精度）
```bash
ENABLE_METADATA_CHECK=true
METADATA_STRATEGY=full
```

### 3. 禁用检测
```bash
ENABLE_METADATA_CHECK=false
# 或者
METADATA_STRATEGY=none
```

## 工作流程

### 基本策略流程
1. **扫描文件**：扫描本地文件并计算校验和
2. **本地状态比较**：与本地状态文件比较，检测变化
3. **云端大小检查**：检查云端文件大小是否相同
4. **智能上传**：只上传真正需要上传的文件

### 完整策略流程
1. **扫描文件**：扫描本地文件并计算校验和
2. **本地状态比较**：与本地状态文件比较，检测变化
3. **云端校验和检查**：检查云端文件的校验和是否相同
4. **智能上传**：只上传真正需要上传的文件
5. **元数据存储**：上传成功后存储文件元数据

## 优势

1. **节省存储空间**：避免重复上传相同文件
2. **提高效率**：减少不必要的网络传输
3. **降低成本**：减少B2存储费用
4. **灵活配置**：可根据需求选择不同策略
5. **减少重复**：基本策略避免了元数据文件的重复存储

## 注意事项

1. **基本策略**：只依赖本地状态文件和文件大小比较，存储开销最小
2. **完整策略**：元数据文件会占用少量额外存储空间
3. **首次运行**：完整策略会为现有文件创建元数据
4. **删除文件**：完整策略会同时删除对应的元数据文件
5. **本地状态文件**：所有策略都依赖本地状态文件进行详细跟踪

## 日志输出

程序会输出详细的日志信息：
- `File xxx unchanged, skipping` - 文件未改变，跳过
- `File xxx content unchanged, only metadata updated` - 内容未改变，只更新元数据
- `File xxx has same size (basic check), skipping upload` - 大小相同，跳过上传
- `File xxx has same checksum (full check), skipping upload` - 校验和相同，跳过上传
- `File xxx will be uploaded (no duplicate check)` - 无检测，直接上传 